<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Battery Pack Viewer</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #0A0E1A;
            --card: rgba(255, 255, 255, 0.04);
            --border: rgba(255, 255, 255, 0.08);
            --primary: #00D9FF;
            --secondary: #7B61FF;
            --success: #00E676;
            --warn: #FFD600;
            --danger: #FF5252;
            --muted: #6B7280;
            --text: #F0F4FF;
            --text2: #A0AEC0
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column
        }

        .bg-grid {
            position: fixed;
            inset: 0;
            z-index: 0;
            background-image: linear-gradient(rgba(0, 217, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 217, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none
        }

        .orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            pointer-events: none;
            z-index: 0
        }

        .o1 {
            width: 350px;
            height: 350px;
            background: rgba(0, 217, 255, 0.06);
            top: -80px;
            left: -80px
        }

        .o2 {
            width: 350px;
            height: 350px;
            background: rgba(123, 97, 255, 0.06);
            bottom: -80px;
            right: -80px
        }

        header {
            position: relative;
            z-index: 10;
            background: rgba(17, 24, 39, 0.85);
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(20px);
            padding: 0.6rem 1.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: var(--primary);
            text-decoration: none;
            font-size: 0.82rem;
            font-weight: 600;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.25);
            padding: 0.35rem 0.8rem;
            border-radius: 8px;
            transition: all 0.2s
        }

        .back-btn:hover {
            background: rgba(0, 217, 255, 0.2)
        }

        .htitle {
            font-size: 1rem;
            font-weight: 700
        }

        .htitle span {
            color: var(--primary)
        }

        .hint-bar {
            font-size: 0.72rem;
            color: var(--muted)
        }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            z-index: 1
        }

        .sidebar {
            width: 290px;
            min-width: 290px;
            background: rgba(17, 24, 39, 0.88);
            border-right: 1px solid var(--border);
            backdrop-filter: blur(20px);
            overflow-y: auto;
            padding: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem
        }

        .sidebar::-webkit-scrollbar {
            width: 3px
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px
        }

        .stitle {
            font-size: 0.68rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--muted);
            margin-bottom: 0.4rem
        }

        .mode-tabs {
            display: flex;
            gap: 0.4rem
        }

        .tab {
            flex: 1;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text2);
            text-align: center;
            transition: all 0.2s
        }

        .tab.active {
            border-color: var(--primary);
            background: rgba(0, 217, 255, 0.12);
            color: var(--primary)
        }

        .shape-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.4rem
        }

        .sbtn {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 0.3rem;
            cursor: pointer;
            font-size: 0.68rem;
            font-weight: 500;
            color: var(--text2);
            text-align: center;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem
        }

        .sbtn svg {
            width: 24px;
            height: 24px
        }

        .sbtn:hover {
            border-color: var(--border);
            color: var(--primary)
        }

        .sbtn.active {
            border-color: var(--primary);
            background: rgba(0, 217, 255, 0.1);
            color: var(--primary)
        }

        .fg {
            display: flex;
            flex-direction: column;
            gap: 0.3rem
        }

        .fl {
            font-size: 0.76rem;
            font-weight: 500;
            color: var(--text2)
        }

        .fi {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.45rem 0.7rem;
            color: var(--text);
            font-size: 0.82rem;
            font-family: 'JetBrains Mono', monospace;
            width: 100%;
            transition: border-color 0.2s
        }

        .fi:focus {
            outline: none;
            border-color: var(--primary)
        }

        select.fi option {
            background: #111827
        }

        .row2 {
            display: flex;
            gap: 0.4rem
        }

        .row2 .fg {
            flex: 1
        }

        hr {
            border: none;
            border-top: 1px solid var(--border)
        }

        .gbtn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 10px;
            padding: 0.7rem;
            color: #fff;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px
        }

        .gbtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 217, 255, 0.3)
        }

        .sp {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.8rem
        }

        .sr {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.28rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            font-size: 0.78rem
        }

        .sr:last-child {
            border-bottom: none
        }

        .sr .n {
            color: var(--muted)
        }

        .sr .v {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--primary)
        }

        .v.g {
            color: var(--success)
        }

        .v.y {
            color: var(--warn)
        }

        .v.r {
            color: var(--danger)
        }

        .cs {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap
        }

        .csw {
            width: 22px;
            height: 22px;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.15s
        }

        .csw.active,
        .csw:hover {
            border-color: #fff
        }

        .legend {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 5;
            background: rgba(10, 14, 26, 0.88);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.7rem;
            backdrop-filter: blur(10px);
            font-size: 0.73rem;
            display: none
        }

        .legend.vis {
            display: block
        }

        .li {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.25rem;
            color: var(--text2)
        }

        .li:last-child {
            margin: 0
        }

        .ld {
            width: 11px;
            height: 11px;
            border-radius: 3px
        }

        .sb {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 5;
            background: rgba(10, 14, 26, 0.85);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.35rem 0.7rem;
            font-size: 0.73rem;
            color: var(--muted);
            backdrop-filter: blur(10px)
        }

        .sb span {
            color: var(--primary);
            font-weight: 600
        }

        .canvas-area {
            flex: 1;
            position: relative;
            background: var(--bg)
        }

        #c {
            width: 100% !important;
            height: 100% !important;
            display: block
        }

        .vbtns {
            position: absolute;
            bottom: 1.2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.4rem;
            z-index: 5
        }

        .vb {
            background: rgba(10, 14, 26, 0.85);
            border: 1px solid var(--border);
            border-radius: 7px;
            padding: 0.4rem 0.8rem;
            color: var(--text2);
            font-size: 0.73rem;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px)
        }

        .vb:hover {
            border-color: var(--primary);
            color: var(--primary)
        }

        .hint {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            transition: opacity 0.4s
        }

        .hint .hi {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(0, 217, 255, 0.07);
            border: 2px dashed rgba(0, 217, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            animation: pu 2s infinite
        }

        @keyframes pu {

            0%,
            100% {
                transform: scale(1);
                opacity: 1
            }

            50% {
                transform: scale(1.08);
                opacity: 0.6
            }
        }

        .hint p {
            color: var(--muted);
            font-size: 0.88rem;
            text-align: center
        }

        .hint strong {
            color: var(--primary)
        }

        .hint.hidden {
            opacity: 0
        }

        .cfg-banner {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.08), rgba(123, 97, 255, 0.08));
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 10px;
            padding: 0.75rem;
            font-size: 0.78rem;
            color: var(--text2)
        }

        .cfg-banner strong {
            color: var(--primary);
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.85rem
        }
    </style>
</head>

<body>
    <div class="bg-grid"></div>
    <div class="orb o1"></div>
    <div class="orb o2"></div>
    <header>
        <div style="display:flex;align-items:center;gap:0.8rem">
            <a href="index.html" class="back-btn">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="15 18 9 12 15 6" />
                </svg>Back
            </a>
            <div class="htitle">3D Pack <span>Viewer</span></div>
        </div>
        <div class="hint-bar">Left drag = Rotate &nbsp;|&nbsp; Scroll = Zoom &nbsp;|&nbsp; Right drag = Pan</div>
    </header>
    <div class="main">
        <div class="sidebar">
            <div>
                <div class="stitle">View Mode</div>
                <div class="mode-tabs">
                    <div class="tab active" id="tab-connected" onclick="setMode('connected')">âš¡ Connected Pack</div>
                    <div class="tab" id="tab-shape" onclick="setMode('shape')">ðŸ“¦ Shape Packer</div>
                </div>
            </div>

            <!-- Connected pack panel -->
            <div id="panel-connected">
                <div id="cfg-banner" class="cfg-banner" style="display:none">
                    <strong>ðŸ“‹ Loaded from Configurator</strong>
                    <span id="cfg-banner-text"></span>
                </div>
                <hr>
                <div class="stitle">Series & Parallel</div>
                <div class="row2">
                    <div class="fg"><label class="fl">Series (S)</label><input class="fi" id="c-s" type="number"
                            value="2" min="1" max="30" step="1"></div>
                    <div class="fg"><label class="fl">Parallel (P)</label><input class="fi" id="c-p" type="number"
                            value="2" min="1" max="20" step="1"></div>
                </div>
                <div class="fg"><label class="fl">Cell Type</label>
                    <select class="fi" id="c-type" onchange="autoCellDims()">
                        <option value="18650">18650 â€“ Ã˜18Ã—65mm</option>
                        <option value="21700">21700 â€“ Ã˜21Ã—70mm</option>
                        <option value="26650">26650 â€“ Ã˜26Ã—65mm</option>
                        <option value="32650">32650 â€“ Ã˜32Ã—65mm</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="row2" id="c-dims">
                    <div class="fg"><label class="fl">Ã˜ Diameter (mm)</label><input class="fi" id="c-d" type="number"
                            value="18" min="5" max="60" step="0.5"></div>
                    <div class="fg"><label class="fl">Length (mm)</label><input class="fi" id="c-l" type="number"
                            value="65" min="20" max="300" step="0.5"></div>
                </div>
                <div class="row2">
                    <div class="fg"><label class="fl">Gap (mm)</label><input class="fi" id="c-gap" type="number"
                            value="1" min="0" max="10" step="0.5"></div>
                    <div class="fg"><label class="fl">BMS</label>
                        <select class="fi" id="c-bms">
                            <option value="1">Yes</option>
                            <option value="0">No</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Shape pack panel -->
            <div id="panel-shape" style="display:none">
                <div class="stitle">Pack Shape</div>
                <div class="shape-grid">
                    <div class="sbtn active" data-sh="rectangle" onclick="selSh('rectangle',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="6" width="20" height="12" rx="1" />
                        </svg>Rect
                    </div>
                    <div class="sbtn" data-sh="square" onclick="selSh('square',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="1" />
                        </svg>Square
                    </div>
                    <div class="sbtn" data-sh="circle" onclick="selSh('circle',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="9" />
                        </svg>Circle
                    </div>
                    <div class="sbtn" data-sh="hexagon" onclick="selSh('hexagon',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12,2 21,7 21,17 12,22 3,17 3,7" />
                        </svg>Hex
                    </div>
                    <div class="sbtn" data-sh="octagon" onclick="selSh('octagon',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="9,2 15,2 22,9 22,15 15,22 9,22 2,15 2,9" />
                        </svg>Oct
                    </div>
                    <div class="sbtn" data-sh="triangle" onclick="selSh('triangle',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12,2 22,22 2,22" />
                        </svg>Tri
                    </div>
                </div>
                <div id="sh-dim-fields" style="margin-top:0.5rem"></div>
                <div class="fg"><label class="fl">Cell Type</label>
                    <select class="fi" id="s-type" onchange="autoCellDimsShape()">
                        <option value="18650">18650 â€“ Ã˜18Ã—65mm</option>
                        <option value="21700">21700 â€“ Ã˜21Ã—70mm</option>
                        <option value="26650">26650 â€“ Ã˜26Ã—65mm</option>
                        <option value="32650">32650 â€“ Ã˜32Ã—65mm</option>
                    </select>
                </div>
                <div class="row2">
                    <div class="fg"><label class="fl">Gap (mm)</label><input class="fi" id="s-gap" type="number"
                            value="1" min="0" max="10" step="0.5"></div>
                    <div class="fg"><label class="fl">Wall (mm)</label><input class="fi" id="s-wall" type="number"
                            value="3" min="0" max="15" step="0.5"></div>
                </div>
            </div>

            <hr>
            <div class="stitle">Cell Color</div>
            <div class="cs" id="swatches">
                <div class="csw active" style="background:#00D9FF" data-c="#00D9FF" onclick="selColor(this)"></div>
                <div class="csw" style="background:#00E676" data-c="#00E676" onclick="selColor(this)"></div>
                <div class="csw" style="background:#FF9800" data-c="#FF9800" onclick="selColor(this)"></div>
                <div class="csw" style="background:#7B61FF" data-c="#7B61FF" onclick="selColor(this)"></div>
                <div class="csw" style="background:#FF5252" data-c="#FF5252" onclick="selColor(this)"></div>
                <div class="csw" style="background:#E0E0E0" data-c="#E0E0E0" onclick="selColor(this)"></div>
            </div>
            <button class="gbtn" onclick="generate()">âš¡ Generate 3D Pack</button>
            <hr>
            <div class="stitle">Pack Statistics</div>
            <div class="sp">
                <div class="sr"><span class="n">Cells Total</span><span class="v" id="st-cells">â€”</span></div>
                <div class="sr"><span class="n">Configuration</span><span class="v" id="st-cfg">â€”</span></div>
                <div class="sr"><span class="n">Pack Voltage</span><span class="v y" id="st-v">â€”</span></div>
                <div class="sr"><span class="n">Pack Capacity</span><span class="v" id="st-cap">â€”</span></div>
                <div class="sr"><span class="n">Total Energy</span><span class="v g" id="st-e">â€”</span></div>
                <div class="sr"><span class="n">Pack Dimensions</span><span class="v" id="st-dims">â€”</span></div>
                <div class="sr"><span class="n">Fill Efficiency</span><span class="v g" id="st-fill">â€”</span></div>
            </div>
        </div>

        <div class="canvas-area">
            <div class="sb" id="statusbadge">Configure and click <span>Generate 3D Pack</span></div>
            <div class="hint" id="hint">
                <div class="hi">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#00D9FF" stroke-width="1.5">
                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                        <path d="M2 17l10 5 10-5" />
                        <path d="M2 12l10 5 10-5" />
                    </svg>
                </div>
                <p>Select mode and configure your pack,</p>
                <p>then click <strong>Generate 3D Pack</strong></p>
            </div>
            <canvas id="c"></canvas>
            <div class="legend" id="legend">
                <div class="li">
                    <div class="ld" style="background:#00D9FF"></div>Battery Cells
                </div>
                <div class="li">
                    <div class="ld" style="background:#FF5252"></div>Positive Bus / Terminal
                </div>
                <div class="li">
                    <div class="ld" style="background:#212121;border:1px solid #555"></div>Negative Bus
                </div>
                <div class="li">
                    <div class="ld" style="background:#00E676"></div>Balance Wires / BMS
                </div>
                <div class="li">
                    <div class="ld" style="background:#2196F3"></div>Load Output
                </div>
                <div class="li">
                    <div class="ld" style="background:#FF9800"></div>Charger Output
                </div>
            </div>
            <div class="vbtns">
                <button class="vb" onclick="sv('top')">â¬† Top</button>
                <button class="vb" onclick="sv('front')">â†” Front</button>
                <button class="vb" onclick="sv('side')">â†• Side</button>
                <button class="vb" onclick="sv('iso')">âŸ³ Iso</button>
                <button class="vb" onclick="rv()">âŠ™ Reset</button>
            </div>
        </div>
    </div>

    <script>
        // â”€â”€ Three.js Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const canvas = document.getElementById('c');
        const ca = document.querySelector('.canvas-area');
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.setClearColor(0x0A0E1A, 1);
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 5000);
        camera.position.set(200, 200, 280);
        const controls = new THREE.OrbitControls(camera, canvas);
        controls.enableDamping = true; controls.dampingFactor = 0.08;
        // Lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.55));
        const dl = new THREE.DirectionalLight(0xffffff, 1.05);
        dl.position.set(200, 400, 200); dl.castShadow = true;
        dl.shadow.mapSize.set(2048, 2048); scene.add(dl);
        const fl = new THREE.DirectionalLight(0x00D9FF, 0.35); fl.position.set(-200, 100, -200); scene.add(fl);
        const rl = new THREE.DirectionalLight(0x7B61FF, 0.2); rl.position.set(0, -100, -200); scene.add(rl);
        scene.add(new THREE.GridHelper(800, 32, 0x1a2035, 0x1a2035));
        function resize() { const w = ca.clientWidth, h = ca.clientHeight; renderer.setSize(w, h); camera.aspect = w / h; camera.updateProjectionMatrix(); }
        window.addEventListener('resize', resize); resize();
        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
        animate();

        // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let mode = 'connected'; // 'connected' | 'shape'
        let selShape = 'rectangle';
        let cellColor = '#00D9FF';
        let packGroup = null;
        const PRESETS = { '18650': { d: 18, l: 65 }, '21700': { d: 21, l: 70 }, '26650': { d: 26, l: 65 }, '32650': { d: 32, l: 65 } };

        // â”€â”€ URL Params (from configurator) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const UP = new URLSearchParams(window.location.search);
        if (UP.has('s')) {
            document.getElementById('c-s').value = UP.get('s');
            document.getElementById('c-p').value = UP.get('p');
            const t = UP.get('type') || '18650';
            document.getElementById('c-type').value = PRESETS[t] ? t : 'custom';
            document.getElementById('c-d').value = UP.get('d') || 18;
            document.getElementById('c-l').value = UP.get('l') || 65;
            document.getElementById('c-bms').value = UP.get('bms') || '1';
            const banner = document.getElementById('cfg-banner');
            banner.style.display = 'block';
            const S = UP.get('s'), P = UP.get('p'), V = (parseFloat(UP.get('voltage') || 3.7) * parseInt(S)).toFixed(1);
            const cap = (parseInt(UP.get('capacity') || 3000) * parseInt(P));
            document.getElementById('cfg-banner-text').textContent = `${S}S${P}P Â· ${t} Â· ${V}V Â· ${cap}mAh`;
        }
        renderShapeDimFields();

        // â”€â”€ Mode Switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function setMode(m) {
            mode = m;
            document.getElementById('tab-connected').classList.toggle('active', m === 'connected');
            document.getElementById('tab-shape').classList.toggle('active', m === 'shape');
            document.getElementById('panel-connected').style.display = m === 'connected' ? 'flex' : 'none';
            document.getElementById('panel-connected').style.flexDirection = 'column';
            document.getElementById('panel-connected').style.gap = '0.7rem';
            document.getElementById('panel-shape').style.display = m === 'shape' ? 'flex' : 'none';
            document.getElementById('panel-shape').style.flexDirection = 'column';
            document.getElementById('panel-shape').style.gap = '0.6rem';
        }
        setMode('connected');

        function selSh(sh, btn) {
            selShape = sh;
            document.querySelectorAll('.sbtn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderShapeDimFields();
        }
        function selColor(sw) {
            document.querySelectorAll('.csw').forEach(s => s.classList.remove('active'));
            sw.classList.add('active'); cellColor = sw.dataset.c;
        }
        function autoCellDims() {
            const t = document.getElementById('c-type').value;
            const pr = PRESETS[t];
            if (pr) { document.getElementById('c-d').value = pr.d; document.getElementById('c-l').value = pr.l; }
        }
        function autoCellDimsShape() {
            const t = document.getElementById('s-type').value;
            const pr = PRESETS[t];
            if (pr) { document.getElementById('c-d').value = pr.d; document.getElementById('c-l').value = pr.l; }
        }
        function gv(id, fb) { const el = document.getElementById(id); return el ? parseFloat(el.value) || fb : fb; }

        // â”€â”€ Shape Dimension Fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderShapeDimFields() {
            const c = document.getElementById('sh-dim-fields');
            const inpCls = 'class="fi"';
            if (selShape === 'rectangle') c.innerHTML = `<div class="row2"><div class="fg"><label class="fl">Width(mm)</label><input ${inpCls} id="d-w" type="number" value="200" min="20" step="5"></div><div class="fg"><label class="fl">Depth(mm)</label><input ${inpCls} id="d-d" type="number" value="100" min="20" step="5"></div></div><div class="fg" style="margin-top:0.35rem"><label class="fl">Height(mm)</label><input ${inpCls} id="d-h" type="number" value="70" step="5"></div>`;
            else if (selShape === 'square') c.innerHTML = `<div class="fg"><label class="fl">Side(mm)</label><input ${inpCls} id="d-s" type="number" value="150" step="5"></div><div class="fg" style="margin-top:0.35rem"><label class="fl">Height(mm)</label><input ${inpCls} id="d-h" type="number" value="70" step="5"></div>`;
            else if (selShape === 'circle' || selShape === 'hexagon') c.innerHTML = `<div class="fg"><label class="fl">Radius(mm)</label><input ${inpCls} id="d-r" type="number" value="80" step="5"></div><div class="fg" style="margin-top:0.35rem"><label class="fl">Height(mm)</label><input ${inpCls} id="d-h" type="number" value="70" step="5"></div>`;
            else if (selShape === 'octagon' || selShape === 'triangle') c.innerHTML = `<div class="fg"><label class="fl">Width(mm)</label><input ${inpCls} id="d-w" type="number" value="160" step="5"></div><div class="fg" style="margin-top:0.35rem"><label class="fl">Height(mm)</label><input ${inpCls} id="d-h" type="number" value="70" step="5"></div>`;
        }

        // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function mkCyl(rT, rB, h, segs, color, emissInt = 0.05) {
            return new THREE.MeshPhysicalMaterial({ color: new THREE.Color(color), metalness: 0.5, roughness: 0.3, emissive: new THREE.Color(color), emissiveIntensity: emissInt });
        }
        function addMesh(geo, mat, g, x, y, z, rx = 0) {
            const m = new THREE.Mesh(geo, mat); m.position.set(x, y, z); if (rx) m.rotation.x = rx;
            m.castShadow = true; g.add(m); return m;
        }
        function tube(g, x1, y1, z1, x2, y2, z2, color, r = 1.5) {
            const p1 = new THREE.Vector3(x1, y1, z1), p2 = new THREE.Vector3(x2, y2, z2);
            const dir = new THREE.Vector3().subVectors(p2, p1);
            const len = dir.length(); if (len < 0.001) return;
            const mid = new THREE.Vector3().addVectors(p1, p2).multiplyScalar(0.5);
            const geo = new THREE.CylinderGeometry(r, r, len, 8);
            const mat = new THREE.MeshStandardMaterial({ color: new THREE.Color(color), metalness: 0.4, roughness: 0.5 });
            const m = new THREE.Mesh(geo, mat);
            m.position.copy(mid);
            m.quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), dir.normalize());
            m.castShadow = true; g.add(m);
        }
        function box(g, W, H, D, color, x, y, z, opacity = 1) {
            const geo = new THREE.BoxGeometry(W, H, D);
            const mat = new THREE.MeshPhysicalMaterial({ color: new THREE.Color(color), metalness: 0.3, roughness: 0.4, transparent: opacity < 1, opacity });
            const m = new THREE.Mesh(geo, mat); m.position.set(x, y, z); m.castShadow = true; g.add(m); return m;
        }
        function label3d(g, text, x, y, z, color = '#ffffff', size = 8) {
            // Use a sprite for simple labels
            const canvas2 = document.createElement('canvas'); canvas2.width = 256; canvas2.height = 64;
            const ctx = canvas2.getContext('2d');
            ctx.fillStyle = color; ctx.font = `bold ${size * 4}px Inter,sans-serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(text, 128, 32);
            const tex = new THREE.CanvasTexture(canvas2);
            const mat = new THREE.SpriteMaterial({ map: tex, transparent: true });
            const sp = new THREE.Sprite(mat); sp.scale.set(size * 4, size, 1); sp.position.set(x, y, z); g.add(sp);
        }

        // â”€â”€ Make one cylindrical cell (realistic) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function makeCell(g, x, y, z, d, l, color) {
            const r = d / 2;
            const gr = new THREE.Group();

            // Main body â€” metallic cylinder with correct material
            const bodyGeo = new THREE.CylinderGeometry(r, r, l, 32);
            const bodyMat = new THREE.MeshPhysicalMaterial({
                color: new THREE.Color(color), metalness: 0.55, roughness: 0.28,
                emissive: new THREE.Color(color), emissiveIntensity: 0.04,
                clearcoat: 0.6, clearcoatRoughness: 0.2
            });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.castShadow = true; gr.add(body);

            // Label wrap (dark band around middle)
            const wrapGeo = new THREE.CylinderGeometry(r + 0.25, r + 0.25, l * 0.5, 32);
            const wrapMat = new THREE.MeshStandardMaterial({ color: 0x0a0f14, metalness: 0, roughness: 0.95, transparent: true, opacity: 0.82 });
            gr.add(new THREE.Mesh(wrapGeo, wrapMat));

            // Groove ring (realistic cell detail)
            const grooveGeo = new THREE.TorusGeometry(r - 0.5, 0.6, 6, 32);
            const grooveMat = new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 0.3, roughness: 0.7 });
            const groove = new THREE.Mesh(grooveGeo, grooveMat);
            groove.rotation.x = Math.PI / 2;
            groove.position.y = l * 0.38;
            gr.add(groove);

            // Shine stripe
            const stripeGeo = new THREE.CylinderGeometry(r + 0.28, r + 0.28, l * 0.08, 8);
            const stripeMat = new THREE.MeshStandardMaterial({ color: 0xffffff, transparent: true, opacity: 0.08, roughness: 0.5 });
            const stripe = new THREE.Mesh(stripeGeo, stripeMat);
            stripe.position.y = l * 0.15;
            gr.add(stripe);

            // Positive terminal cap (bright silver nub)
            const capGeo = new THREE.CylinderGeometry(r * 0.38, r * 0.45, 2.5, 16);
            const capMat = new THREE.MeshPhysicalMaterial({ color: 0xcccccc, metalness: 1.0, roughness: 0.05 });
            const cap = new THREE.Mesh(capGeo, capMat);
            cap.position.y = l / 2 + 1.3; gr.add(cap);
            // Positive nub top disc
            const nubGeo = new THREE.CylinderGeometry(r * 0.28, r * 0.28, 1, 12);
            const nubMat = new THREE.MeshPhysicalMaterial({ color: 0xe0e0e0, metalness: 1.0, roughness: 0.03 });
            const nub = new THREE.Mesh(nubGeo, nubMat);
            nub.position.y = l / 2 + 2.8; gr.add(nub);

            // Negative flat base
            const negGeo = new THREE.CylinderGeometry(r, r, 1.5, 32);
            const negMat = new THREE.MeshPhysicalMaterial({ color: 0x888888, metalness: 0.9, roughness: 0.15 });
            const neg = new THREE.Mesh(negGeo, negMat);
            neg.position.y = -l / 2 - 0.75; gr.add(neg);

            gr.position.set(x, y, z);
            g.add(gr);
        }

        // â”€â”€ Build Connected (Wired) Pack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function buildConnectedPack() {
            const S = parseInt(gv('c-s', 2)), P = parseInt(gv('c-p', 2));
            const d = parseFloat(gv('c-d', 18)), l = parseFloat(gv('c-l', 65));
            const gap = parseFloat(gv('c-gap', 1));
            const bms = document.getElementById('c-bms').value === '1';
            const pitch = d + gap * 2;
            const g = new THREE.Group();
            const halfZ = (P - 1) * pitch / 2, halfX = (S - 1) * pitch / 2;
            const halfL = l / 2;

            // â”€â”€ Cells grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            for (let s = 0; s < S; s++) {
                for (let p = 0; p < P; p++) {
                    makeCell(g, s * pitch - halfX, 0, p * pitch - halfZ, d, l, cellColor);
                }
            }

            // â”€â”€ Cell holder frames (top + bottom) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Dark plastic frame â€” two horizontal slabs with holes punched
            const frameThk = 5, frameW = S * pitch + 4, frameD = P * pitch + 4;
            const frameMat = new THREE.MeshPhysicalMaterial({ color: 0x1a1a1a, metalness: 0.05, roughness: 0.9 });
            // Top frame plate
            const topFrameGeo = new THREE.BoxGeometry(frameW, frameThk, frameD);
            const topFrame = new THREE.Mesh(topFrameGeo, frameMat);
            topFrame.position.set(-halfX + (S - 1) * pitch / 2, halfL + frameThk / 2 + 1, -halfZ + (P - 1) * pitch / 2);
            g.add(topFrame);
            // Bottom frame plate
            const botFrame = new THREE.Mesh(topFrameGeo, frameMat);
            botFrame.position.set(-halfX + (S - 1) * pitch / 2, -halfL - frameThk / 2 - 1, -halfZ + (P - 1) * pitch / 2);
            g.add(botFrame);

            // Cell holder holes (rings showing through the frame)
            for (let s = 0; s < S; s++) {
                for (let p = 0; p < P; p++) {
                    const cx = s * pitch - halfX, cz = p * pitch - halfZ;
                    const holeGeo = new THREE.CylinderGeometry(d / 2 - 0.5, d / 2 - 0.5, frameThk + 2, 20);
                    const holeMat = new THREE.MeshPhysicalMaterial({ color: 0x0a0a0a, metalness: 0, roughness: 1 });
                    const topH = new THREE.Mesh(holeGeo, holeMat);
                    topH.position.set(cx, halfL + frameThk / 2 + 1, cz); g.add(topH);
                    const botH = new THREE.Mesh(holeGeo, holeMat);
                    botH.position.set(cx, -halfL - frameThk / 2 - 1, cz); g.add(botH);
                    // Frame spoke dividers (cross pattern between holes)
                    if (s < S - 1) {
                        const spokW = pitch - d, spokGeo = new THREE.BoxGeometry(spokW, frameThk + 0.5, 3);
                        const sk = new THREE.Mesh(spokGeo, frameMat);
                        sk.position.set(cx + d / 2 + spokW / 2, halfL + frameThk / 2 + 1, cz); g.add(sk);
                        const sb = sk.clone(); sb.position.y = -halfL - frameThk / 2 - 1; g.add(sb);
                    }
                }
            }

            // â”€â”€ Flat nickel bus strips (top: positive, bottom: negative) â”€â”€
            const stripH = 3, stripD = P * pitch;
            const posStripMat = new THREE.MeshPhysicalMaterial({ color: 0xCD9B1D, metalness: 0.92, roughness: 0.12 });
            const negStripMat = new THREE.MeshPhysicalMaterial({ color: 0x444444, metalness: 0.85, roughness: 0.2 });
            for (let s = 0; s < S; s++) {
                const sx = s * pitch - halfX;
                // Top positive strip per column
                const tp = new THREE.Mesh(new THREE.BoxGeometry(d, stripH, stripD), posStripMat);
                tp.position.set(sx, halfL + frameThk + stripH / 2 + 1, -halfZ + (P - 1) * pitch / 2);
                g.add(tp);
                // Weld dots on strip
                for (let p = 0; p < P; p++) {
                    const wld = new THREE.Mesh(new THREE.CylinderGeometry(2.5, 2.5, 1, 8),
                        new THREE.MeshPhysicalMaterial({ color: 0xE8C060, metalness: 0.95, roughness: 0.05 }));
                    wld.position.set(sx, halfL + frameThk + stripH + 2, p * pitch - halfZ);
                    g.add(wld);
                }
                // Bottom negative strip per column
                const bn = new THREE.Mesh(new THREE.BoxGeometry(d, stripH, stripD), negStripMat);
                bn.position.set(sx, -halfL - frameThk - stripH / 2 - 1, -halfZ + (P - 1) * pitch / 2);
                g.add(bn);
            }
            // Series connection strips (alternating top/bottom bridges)
            const bridgeMat = new THREE.MeshPhysicalMaterial({ color: 0xCC2200, metalness: 0.85, roughness: 0.15 });
            for (let s = 0; s < S - 1; s++) {
                const x1 = s * pitch - halfX, x2 = (s + 1) * pitch - halfX;
                const bw = x2 - x1, bh = 3.5;
                const bridgeGeo = new THREE.BoxGeometry(bw, bh, stripD * 0.55);
                const br = new THREE.Mesh(bridgeGeo, bridgeMat);
                br.position.set((x1 + x2) / 2, halfL + frameThk + bh / 2 + 2, -(P - 1) * pitch / 6);
                g.add(br);
            }

            // â”€â”€ BMS mounted on TOP of pack (reference image style) â”€â”€
            const topSurfY = halfL + frameThk + stripH + 8;
            const bmsW = Math.max(60, S * pitch * 0.65), bmsH_3d = 15, bmsD = Math.max(45, P * pitch * 0.7);
            const bmsPosX = -(S - 1) * pitch / 4, bmsPosZ = 0;

            if (bms) {
                // BMS enclosure (orange-brown like reference image 1)
                const bmsGeo = new THREE.BoxGeometry(bmsW, bmsH_3d, bmsD);
                const bmsMat = new THREE.MeshPhysicalMaterial({
                    color: 0x964B00, metalness: 0.15, roughness: 0.55,
                    emissive: 0x3a1a00, emissiveIntensity: 0.12
                });
                const bmsM = new THREE.Mesh(bmsGeo, bmsMat);
                bmsM.position.set(bmsPosX, topSurfY + bmsH_3d / 2, bmsPosZ);
                bmsM.castShadow = true; g.add(bmsM);
                // BMS edge lines
                const bmsEdge2 = new THREE.LineSegments(new THREE.EdgesGeometry(bmsGeo),
                    new THREE.LineBasicMaterial({ color: 0xCC6600, opacity: 0.7, transparent: true }));
                bmsEdge2.position.copy(bmsM.position); g.add(bmsEdge2);

                // Connector block on BMS (like DALY connector reference)
                const connGeo = new THREE.BoxGeometry(20, 8, bmsD * 0.6);
                const connMat = new THREE.MeshPhysicalMaterial({ color: 0x1a1a1a, metalness: 0.5, roughness: 0.4 });
                const conn = new THREE.Mesh(connGeo, connMat);
                conn.position.set(bmsPosX + bmsW / 2 - 10, topSurfY + bmsH_3d + 4, 0);
                g.add(conn);
                // Connector pins
                for (let i = 0; i < 4; i++) {
                    const pinGeo = new THREE.CylinderGeometry(1.5, 1.5, 5, 8);
                    const pin = new THREE.Mesh(pinGeo, new THREE.MeshPhysicalMaterial({ color: 0xaaaaaa, metalness: 1, roughness: 0.05 }));
                    pin.position.set(bmsPosX + bmsW / 2 - 10, topSurfY + bmsH_3d + 9, (i - 1.5) * 7);
                    g.add(pin);
                }

                // BMS wire to positive terminal (B+)
                const bpx = (S - 1) * pitch - halfX;
                tube(g, bpx, halfL + frameThk, 0, bpx, topSurfY, 0, '#CC2222', 3);
                tube(g, bpx, topSurfY, 0, bmsPosX + bmsW / 2, topSurfY, 0, '#CC2222', 3);
                // BMS wire B-
                tube(g, -halfX, halfL + frameThk, 0, -halfX, topSurfY, 0, '#222222', 3);
                tube(g, -halfX, topSurfY, 0, bmsPosX - bmsW / 2, topSurfY, 0, '#222222', 3);
                // Balance cable (green flat ribbon from front side)
                const balCableGeo = new THREE.BoxGeometry(1.5, bmsD * 0.7, 6);
                const balCableMat = new THREE.MeshStandardMaterial({ color: 0x1B5E20, roughness: 0.8 });
                const balCable = new THREE.Mesh(balCableGeo, balCableMat);
                balCable.position.set(bmsPosX - bmsW / 2, topSurfY + bmsH_3d / 2, -halfZ - 8);
                g.add(balCable);
                label3d(g, 'BMS', bmsPosX, topSurfY + bmsH_3d + 14, 0, '#FFEB3B', 10);
            }

            // â”€â”€ Enclosure box (rounded corners, semi-transparent) â”€â”€â”€
            const packW2 = S * pitch + d + 4, packD2 = P * pitch + d + 4;
            const enclosureH = l + frameThk * 2 + 20;
            const enc = box(g, packW2, enclosureH, packD2, '#0d1520', 0, 0, 0, 0.12);
            const encEdge = new THREE.LineSegments(
                new THREE.EdgesGeometry(new THREE.BoxGeometry(packW2, enclosureH, packD2)),
                new THREE.LineBasicMaterial({ color: 0x00D9FF, transparent: true, opacity: 0.3 })
            );
            g.add(encEdge);
            // Corner mounting nubs (like reference image)
            const nubGeo2 = new THREE.CylinderGeometry(4, 4, 6, 12);
            const nubMat2 = new THREE.MeshPhysicalMaterial({ color: 0x111111, metalness: 0.3, roughness: 0.7 });
            [[-1, -1], [1, -1], [-1, 1], [1, 1]].forEach(([sx2, sz2]) => {
                const n = new THREE.Mesh(nubGeo2, nubMat2);
                n.position.set(sx2 * (packW2 / 2 - 5), -enclosureH / 2 - 3, sz2 * (packD2 / 2 - 5));
                g.add(n);
            });

            // â”€â”€ Stats panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const cTotal = S * P;
            const v = parseFloat(UP.get('voltage') || 3.7);
            const cap = parseInt(UP.get('capacity') || 3000);
            document.getElementById('st-cells').textContent = cTotal;
            document.getElementById('st-cfg').textContent = `${S}S${P}P`;
            document.getElementById('st-v').textContent = `${(v * S).toFixed(1)}V`;
            document.getElementById('st-cap').textContent = `${cap * P}mAh`;
            document.getElementById('st-e').textContent = `${((v * S) * (cap * P) / 1000).toFixed(1)}Wh`;
            document.getElementById('st-dims').textContent = `${packW2.toFixed(0)}Ã—${packD2.toFixed(0)}Ã—${enclosureH.toFixed(0)}mm`;
            document.getElementById('st-fill').textContent = `~${Math.round(cTotal * Math.PI * (d / 2) ** 2 / (packW2 * packD2) * 100)}%`;
            document.getElementById('statusbadge').innerHTML = `<span>${cTotal} cells</span> Â· ${S}S${P}P${bms ? ' Â· BMS' : ''}`;
            return g;
        }



        // â”€â”€ Build Shape Pack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function buildShapePack() {
            const gap = gv('s-gap', 1), wall = gv('s-wall', 3);
            const t = document.getElementById('s-type').value;
            const d = PRESETS[t] ? PRESETS[t].d : 18, l = PRESETS[t] ? PRESETS[t].l : 65;
            const pitch = d + gap;
            const g = new THREE.Group();
            let positions = [], dimStr = '';

            if (selShape === 'rectangle') {
                const W = gv('d-w', 200) - wall * 2, D = gv('d-d', 100) - wall * 2;
                const cols = Math.floor(W / pitch), rows = Math.floor(D / pitch);
                for (let r = 0; r < rows; r++) for (let c = 0; c < cols; c++) positions.push({ x: c * pitch - (cols - 1) * pitch / 2, z: r * pitch - (rows - 1) * pitch / 2 });
                dimStr = `${gv('d-w', 200)}Ã—${gv('d-d', 100)}Ã—${gv('d-h', 70)}mm`;
            } else if (selShape === 'square') {
                const S = gv('d-s', 150) - wall * 2;
                const n = Math.floor(S / pitch);
                for (let r = 0; r < n; r++) for (let c = 0; c < n; c++) positions.push({ x: c * pitch - (n - 1) * pitch / 2, z: r * pitch - (n - 1) * pitch / 2 });
                dimStr = `${gv('d-s', 150)}Ã—${gv('d-s', 150)}Ã—${gv('d-h', 70)}mm`;
            } else if (selShape === 'circle') {
                const R = gv('d-r', 80) - wall, rh = pitch * Math.sqrt(3) / 2;
                const nr = Math.ceil(2 * R / rh);
                for (let row = -nr; row <= nr; row++) {
                    const z = row * rh, off = row % 2 === 0 ? 0 : pitch / 2, nc = Math.ceil(2 * R / pitch);
                    for (let col = -nc; col <= nc; col++) { const x = col * pitch + off; if (Math.sqrt(x * x + z * z) + d / 2 <= R) positions.push({ x, z }); }
                }
                dimStr = `Ã˜${gv('d-r', 80) * 2}Ã—${gv('d-h', 70)}mm`;
            } else if (selShape === 'hexagon') {
                const R = gv('d-r', 90) - wall, rh = pitch * Math.sqrt(3) / 2;
                const nr = Math.ceil(2 * R / rh) + 1;
                for (let row = -nr; row <= nr; row++) {
                    const z = row * rh, off = row % 2 === 0 ? 0 : pitch / 2, nc = Math.ceil(2 * R / pitch) + 1;
                    for (let col = -nc; col <= nc; col++) {
                        const x = col * pitch + off;
                        const q = (2 / 3 * x) / R, r2 = (-1 / 3 * x + Math.sqrt(3) / 3 * z) / R;
                        if (Math.max(Math.abs(q), Math.abs(r2), Math.abs(-q - r2)) <= 1) positions.push({ x, z });
                    }
                }
                dimStr = `R${gv('d-r', 90)}Ã—${gv('d-h', 70)}mm`;
            } else if (selShape === 'octagon') {
                const W = gv('d-w', 160) - wall * 2, h = W / 2;
                for (let row = -Math.ceil(h / pitch); row <= Math.ceil(h / pitch); row++) {
                    const z = row * pitch, off = row % 2 === 0 ? 0 : pitch / 2;
                    for (let col = -Math.ceil(h / pitch); col <= Math.ceil(h / pitch); col++) {
                        const x = col * pitch + off;
                        if (Math.abs(x) <= h - d / 2 && Math.abs(z) <= h - d / 2 && Math.abs(x) + Math.abs(z) <= (2 * h - W / 4) - d / 2) positions.push({ x, z });
                    }
                }
                dimStr = `${gv('d-w', 160)}Ã—${gv('d-w', 160)}Ã—${gv('d-h', 70)}mm`;
            } else if (selShape === 'triangle') {
                const W = gv('d-w', 200) - wall * 2, H = W * Math.sqrt(3) / 2, rh = pitch * Math.sqrt(3) / 2;
                const nr = Math.floor(H / rh);
                for (let row = 0; row < nr; row++) {
                    const z = -H / 3 + row * rh + d / 2, rw = W * (1 - row / nr) - d;
                    const nc = Math.floor(rw / pitch); const sx = -(nc - 1) * pitch / 2 + (row % 2 === 0 ? 0 : pitch / 2);
                    for (let col = 0; col < nc; col++)positions.push({ x: sx + col * pitch, z });
                }
                dimStr = `Base ${gv('d-w', 200)}Ã—${gv('d-h', 70)}mm`;
            }

            positions.forEach(p => makeCell(g, p.x, 0, p.z, d, l, cellColor));
            document.getElementById('st-cells').textContent = positions.length;
            document.getElementById('st-cfg').textContent = selShape.charAt(0).toUpperCase() + selShape.slice(1) + ' Pack';
            document.getElementById('st-v').textContent = 'â€”'; document.getElementById('st-cap').textContent = 'â€”'; document.getElementById('st-e').textContent = 'â€”';
            document.getElementById('st-dims').textContent = dimStr;
            const ca2 = positions.length * Math.PI * (d / 2) ** 2;
            document.getElementById('st-fill').textContent = `~${positions.length > 0 ? Math.min(99, Math.round(ca2 / (ca2 / 0.78) * 100)) : 0}%`;
            document.getElementById('statusbadge').innerHTML = `<span>${positions.length} cells</span> Â· ${selShape} shape`;
            return g;
        }

        // â”€â”€ Main Generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function generate() {
            if (packGroup) { scene.remove(packGroup); packGroup = null; }
            document.getElementById('hint').classList.add('hidden');
            document.getElementById('legend').classList.add('vis');
            packGroup = mode === 'connected' ? buildConnectedPack() : buildShapePack();
            scene.add(packGroup);
            autoFitCamera(packGroup);
        }

        // â”€â”€ Auto-fit Camera to pack bounds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function autoFitCamera(group) {
            const box = new THREE.Box3().setFromObject(group);
            if (box.isEmpty()) { rv(); return; }
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const fov = camera.fov * (Math.PI / 180);
            const dist = Math.abs(maxDim / 2 / Math.tan(fov / 2)) * 2.8;
            camera.position.set(
                center.x + dist * 0.55,
                center.y + dist * 0.5,
                center.z + dist * 0.75
            );
            controls.target.copy(center);
            controls.update();
        }

        // â”€â”€ Camera Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function sv(v) {
            if (!packGroup) { rv(); return; }
            const box = new THREE.Box3().setFromObject(packGroup);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const fov = camera.fov * (Math.PI / 180);
            const dist = Math.abs(maxDim / 2 / Math.tan(fov / 2)) * 2.5;
            if (v === 'top') camera.position.set(center.x, center.y + dist, center.z + 0.01);
            else if (v === 'front') camera.position.set(center.x, center.y, center.z + dist);
            else if (v === 'side') camera.position.set(center.x + dist, center.y, center.z);
            else camera.position.set(center.x + dist * 0.6, center.y + dist * 0.6, center.z + dist * 0.6);
            controls.target.copy(center);
            controls.update();
        }

        function rv() {
            if (packGroup) { autoFitCamera(packGroup); return; }
            camera.position.set(200, 180, 280);
            controls.target.set(0, 0, 0);
            controls.update();
        }

        // â”€â”€ Auto-generate if loaded from configurator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (UP.has('s')) {
            setTimeout(() => {
                try {
                    mode = 'connected';
                    document.getElementById('tab-connected').classList.add('active');
                    document.getElementById('tab-shape').classList.remove('active');
                    document.getElementById('panel-connected').style.cssText = 'display:flex;flex-direction:column;gap:0.7rem';
                    document.getElementById('panel-shape').style.display = 'none';
                    if (packGroup) { scene.remove(packGroup); packGroup = null; }
                    document.getElementById('hint').classList.add('hidden');
                    document.getElementById('legend').classList.add('vis');
                    packGroup = buildConnectedPack();
                    scene.add(packGroup);
                    autoFitCamera(packGroup);
                } catch (err) {
                    console.error('3D Pack build error:', err);
                    document.getElementById('statusbadge').innerHTML = '<span style="color:#FF5252">âš  Render error â€” check console</span>';
                }
            }, 400);
        }
    </script>
</body>

</html>